/*
 * Copyright Â© 2023. Mark Mussett.
 * This file is subject to the license terms contained
 * in the license file that is distributed with this file.
 */

package json2xml

import (
	"fmt"
	"github.com/project-flogo/core/activity"
	"github.com/project-flogo/core/support/test"
	"github.com/stretchr/testify/assert"
	"testing"
)

var inputOrdered = []byte(`{"TradePrice":{"price":{"#seq":0,"#text":"1"}}}`)
var inputUnordered = []byte(`{"Envelope":{"-soapenv":"http://schemas.xmlsoap.org/soap/envelope/","-stoc":"http://example.com/stockquote.xsd","Body":{"TradePrice":{"price":34.51}},"Header":""}}`)
var expectedOrdered = []byte(`<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:stoc="http://example.com/stockquote.xsd"><soapenv:Header/><soapenv:Body><stoc:TradePrice><stoc:price/></stoc:TradePrice></soapenv:Body></soapenv:Envelope>`)
var encodedXmlData = []byte(`PHNvYXBlbnY6RW52ZWxvcGUgeG1sbnM6c29hcGVudj0iaHR0cDovL3NjaGVtYXMueG1sc29hcC5vcmcvc29hcC9lbnZlbG9wZS8iIHhtbG5zOmdldD0iaHR0cDovL3d3dy5pYXRhLm9yZy9JQVRBL0VESVNULzIwMTcuMiI+Cgk8c29hcGVudjpCb2R5PgoJCTxPcmRlckNyZWF0ZVJRIFZlcnNpb249IjE3LjIiIFByaW1hcnlMYW5nSUQ9IkVOIiBBbHRMYW5nSUQ9IkVOIiB4bWxucz0iaHR0cDovL3d3dy5pYXRhLm9yZy9JQVRBL0VESVNULzIwMTcuMiI+CgkJCTxEb2N1bWVudD4KCQkJCTxOYW1lPkJBPC9OYW1lPgoJCQk8L0RvY3VtZW50PgoJCQk8UGFydHk+CgkJCQk8U2VuZGVyPgoJCQkJCTxDb3Jwb3JhdGVTZW5kZXI+CgkJCQkJCTxJRD5KQjAwMDAwMDwvSUQ+CgkJCQkJPC9Db3Jwb3JhdGVTZW5kZXI+CgkJCQk8L1NlbmRlcj4KCQkJCTxQYXJ0aWNpcGFudHM+CgkJCQkJPFBhcnRpY2lwYW50PgoJCQkJCQk8VHJhdmVsQWdlbmN5UGFydGljaXBhbnQgU2VxdWVuY2VOdW1iZXI9IjEiPgoJCQkJCQkJPENvbnRhY3RzPgoJCQkJCQkJCTxDb250YWN0PgoJCQkJCQkJCQk8RW1haWxDb250YWN0PgoJCQkJCQkJCQkJPEFkZHJlc3M+YWdlbnQuZW1haWxAeHl6LmNvbTwvQWRkcmVzcz4KCQkJCQkJCQkJPC9FbWFpbENvbnRhY3Q+CgkJCQkJCQkJPC9Db250YWN0PgoJCQkJCQkJPC9Db250YWN0cz4KCQkJCQkJCTxJQVRBX051bWJlcj4wMDAwMDAwMDwvSUFUQV9OdW1iZXI+CgkJCQkJCQk8QWdlbmN5SUQ+VGVzdF9BZ2VuY3k8L0FnZW5jeUlEPgoJCQkJCQk8L1RyYXZlbEFnZW5jeVBhcnRpY2lwYW50PgoJCQkJCTwvUGFydGljaXBhbnQ+CgkJCQk8L1BhcnRpY2lwYW50cz4KCQkJPC9QYXJ0eT4KCQkJPFF1ZXJ5PgoJCQkJPE9yZGVyPgoJCQkJCTxPZmZlciBPZmZlcklEPSJPRi00NGE0NTBlNi03NWIzLTQ0NDMtOWMxOC0xMDI0MTM3YjA4MmYiIE93bmVyPSJCQSIgUmVzcG9uc2VJRD0idHgtMDgtMjAxLTBkNWNhZmRkLWVhMjUtNDhhYy05YTNiLTQyNDgwZGVmY2FkNCI+CgkJCQkJCTxPZmZlckl0ZW0gT2ZmZXJJdGVtSUQ9Ik9GLTQ0YTQ1MGU2LTc1YjMtNDQ0My05YzE4LTEwMjQxMzdiMDgyZi1PSS0xIj4KCQkJCQkJCTxQYXNzZW5nZXJSZWZzPlNIMSBTSDIgU0gzPC9QYXNzZW5nZXJSZWZzPgoJCQkJCQk8L09mZmVySXRlbT4KCQkJCQkJPE9mZmVySXRlbSBPZmZlckl0ZW1JRD0iT0YtNDRhNDUwZTYtNzViMy00NDQzLTljMTgtMTAyNDEzN2IwODJmLU9JLTIiPgoJCQkJCQkJPFBhc3NlbmdlclJlZnM+U0g0IFNINTwvUGFzc2VuZ2VyUmVmcz4KCQkJCQkJPC9PZmZlckl0ZW0+CgkJCQkJCTxPZmZlckl0ZW0gT2ZmZXJJdGVtSUQ9Ik9GLTQ0YTQ1MGU2LTc1YjMtNDQ0My05YzE4LTEwMjQxMzdiMDgyZi1PSS0zIj4KCQkJCQkJCTxQYXNzZW5nZXJSZWZzPlNINiBTSDc8L1Bhc3NlbmdlclJlZnM+CgkJCQkJCTwvT2ZmZXJJdGVtPgoJCQkJCQk8T2ZmZXJJdGVtIE9mZmVySXRlbUlEPSJPRi00NGE0NTBlNi03NWIzLTQ0NDMtOWMxOC0xMDI0MTM3YjA4MmYtT0ktNCI+CgkJCQkJCQk8UGFzc2VuZ2VyUmVmcz5TSDggU0g5PC9QYXNzZW5nZXJSZWZzPgoJCQkJCQk8L09mZmVySXRlbT4KCQkJCQk8L09mZmVyPgoJCQkJPC9PcmRlcj4KCQkJCTxQYXltZW50cz4KCQkJCQk8UGF5bWVudD4KCQkJCQkJPFR5cGU+Q0M8L1R5cGU+CgkJCQkJCTxNZXRob2Q+CgkJCQkJCQk8UGF5bWVudENhcmQ+CgkJCQkJCQkJPENhcmRDb2RlPk1EPC9DYXJkQ29kZT4KCQkJCQkJCQk8Q2FyZE51bWJlcj43Nzc3ODg0NTY2NTY1NzIwPC9DYXJkTnVtYmVyPgoJCQkJCQkJCTxTZXJpZXNDb2RlPjEyMzwvU2VyaWVzQ29kZT4KCQkJCQkJCQk8Q2FyZEhvbGRlck5hbWU+TVIgTUlLRSBURVNUPC9DYXJkSG9sZGVyTmFtZT4KCQkJCQkJCQk8Q2FyZEhvbGRlckJpbGxpbmdBZGRyZXNzPgoJCQkJCQkJCQk8U3RyZWV0PkJlZWNoZXMgQXBhcnRtZW50PC9TdHJlZXQ+CgkJCQkJCQkJCTxTdHJlZXQ+MjAwIExhbXB0b24gUm9hZDwvU3RyZWV0PgoJCQkJCQkJCQk8Q2l0eU5hbWU+TE9OPC9DaXR5TmFtZT4KCQkJCQkJCQkJPFBvc3RhbENvZGU+VFczNDVSVDwvUG9zdGFsQ29kZT4KCQkJCQkJCQkJPENvdW50cnlDb2RlPkdCPC9Db3VudHJ5Q29kZT4KCQkJCQkJCQk8L0NhcmRIb2xkZXJCaWxsaW5nQWRkcmVzcz4KCQkJCQkJCQk8U3VyY2hhcmdlPgoJCQkJCQkJCQk8QW1vdW50IENvZGU9IkdCUCI+MC4wMDwvQW1vdW50PgoJCQkJCQkJCTwvU3VyY2hhcmdlPgoJCQkJCQkJCTxFZmZlY3RpdmVFeHBpcmVEYXRlPgoJCQkJCQkJCQk8RWZmZWN0aXZlPjEyMTI8L0VmZmVjdGl2ZT4KCQkJCQkJCQkJPEV4cGlyYXRpb24+MDIxOTwvRXhwaXJhdGlvbj4KCQkJCQkJCQk8L0VmZmVjdGl2ZUV4cGlyZURhdGU+CgkJCQkJCQk8L1BheW1lbnRDYXJkPgoJCQkJCQk8L01ldGhvZD4KCQkJCQkJPEFtb3VudCBDb2RlPSJHQlAiPjUyOC43MDwvQW1vdW50PgoJCQkJCQk8UGF5ZXI+CgkJCQkJCQk8Q29udGFjdEluZm9SZWZzPlBheWVyPC9Db250YWN0SW5mb1JlZnM+CgkJCQkJCTwvUGF5ZXI+CgkJCQkJPC9QYXltZW50PgoJCQkJPC9QYXltZW50cz4KCQkJCTxEYXRhTGlzdHM+CgkJCQkJPFBhc3Nlbmdlckxpc3Q+CgkJCQkJCTxQYXNzZW5nZXIgUGFzc2VuZ2VySUQ9IlNIMSI+CgkJCQkJCQk8UFRDPkFEVDwvUFRDPgoJCQkJCQkJPEluZGl2aWR1YWw+CgkJCQkJCQkJPEJpcnRoZGF0ZT4xOTgyLTEyLTE1PC9CaXJ0aGRhdGU+CgkJCQkJCQkJPEdlbmRlcj5NYWxlPC9HZW5kZXI+CgkJCQkJCQkJPE5hbWVUaXRsZT5EUjwvTmFtZVRpdGxlPgoJCQkJCQkJCTxHaXZlbk5hbWU+b25lPC9HaXZlbk5hbWU+CgkJCQkJCQkJPFN1cm5hbWU+VEVTVDwvU3VybmFtZT4KCQkJCQkJCTwvSW5kaXZpZHVhbD4KCQkJCQkJCTxDb250YWN0SW5mb1JlZj5Db250YWN0SW5mby1TSDE8L0NvbnRhY3RJbmZvUmVmPgoJCQkJCQk8L1Bhc3Nlbmdlcj4KCQkJCQkJPFBhc3NlbmdlciBQYXNzZW5nZXJJRD0iU0gyIj4KCQkJCQkJCTxQVEM+QURUPC9QVEM+CgkJCQkJCQk8SW5kaXZpZHVhbD4KCQkJCQkJCQk8QmlydGhkYXRlPjE5ODMtMDgtMDU8L0JpcnRoZGF0ZT4KCQkJCQkJCQk8R2VuZGVyPk1hbGU8L0dlbmRlcj4KCQkJCQkJCQk8TmFtZVRpdGxlPkRSPC9OYW1lVGl0bGU+CgkJCQkJCQkJPEdpdmVuTmFtZT5UV088L0dpdmVuTmFtZT4KCQkJCQkJCQk8U3VybmFtZT5URVNUPC9TdXJuYW1lPgoJCQkJCQkJPC9JbmRpdmlkdWFsPgoJCQkJCQkJPEluZmFudFJlZj5TSDk8L0luZmFudFJlZj4KCQkJCQkJPC9QYXNzZW5nZXI+CgkJCQkJCTxQYXNzZW5nZXIgUGFzc2VuZ2VySUQ9IlNIMyI+CgkJCQkJCQk8UFRDPkFEVDwvUFRDPgoJCQkJCQkJPEluZGl2aWR1YWw+CgkJCQkJCQkJPEJpcnRoZGF0ZT4xOTg0LTEyLTE1PC9CaXJ0aGRhdGU+CgkJCQkJCQkJPEdlbmRlcj5NYWxlPC9HZW5kZXI+CgkJCQkJCQkJPE5hbWVUaXRsZT5NUjwvTmFtZVRpdGxlPgoJCQkJCQkJCTxHaXZlbk5hbWU+dGhyZWU8L0dpdmVuTmFtZT4KCQkJCQkJCQk8U3VybmFtZT5URVNUPC9TdXJuYW1lPgoJCQkJCQkJPC9JbmRpdmlkdWFsPgoJCQkJCQkJPEluZmFudFJlZj5TSDg8L0luZmFudFJlZj4KCQkJCQkJPC9QYXNzZW5nZXI+CgkJCQkJCTxQYXNzZW5nZXIgUGFzc2VuZ2VySUQ9IlNINCI+CgkJCQkJCQk8UFRDPkFEVDwvUFRDPgoJCQkJCQkJPEluZGl2aWR1YWw+CgkJCQkJCQkJPEJpcnRoZGF0ZT4yMDA1LTEwLTE1PC9CaXJ0aGRhdGU+CgkJCQkJCQkJPEdlbmRlcj5NYWxlPC9HZW5kZXI+CgkJCQkJCQkJPE5hbWVUaXRsZT5NUjwvTmFtZVRpdGxlPgoJCQkJCQkJCTxHaXZlbk5hbWU+Zm91cjwvR2l2ZW5OYW1lPgoJCQkJCQkJCTxTdXJuYW1lPlRFU1Q8L1N1cm5hbWU+CgkJCQkJCQk8L0luZGl2aWR1YWw+CgkJCQkJCTwvUGFzc2VuZ2VyPgoJCQkJCQk8UGFzc2VuZ2VyIFBhc3NlbmdlcklEPSJTSDUiPgoJCQkJCQkJPFBUQz5BRFQ8L1BUQz4KCQkJCQkJCTxJbmRpdmlkdWFsPgoJCQkJCQkJCTxCaXJ0aGRhdGU+MjAwNS0xMi0xNTwvQmlydGhkYXRlPgoJCQkJCQkJCTxHZW5kZXI+TWFsZTwvR2VuZGVyPgoJCQkJCQkJCTxOYW1lVGl0bGU+TVI8L05hbWVUaXRsZT4KCQkJCQkJCQk8R2l2ZW5OYW1lPmZpdmU8L0dpdmVuTmFtZT4KCQkJCQkJCQk8U3VybmFtZT5URVNUPC9TdXJuYW1lPgoJCQkJCQkJPC9JbmRpdmlkdWFsPgoJCQkJCQk8L1Bhc3Nlbmdlcj4KCQkJCQkJPFBhc3NlbmdlciBQYXNzZW5nZXJJRD0iU0g2Ij4KCQkJCQkJCTxQVEM+Q0hEPC9QVEM+CgkJCQkJCQk8SW5kaXZpZHVhbD4KCQkJCQkJCQk8QmlydGhkYXRlPjIwMTAtMTItMTU8L0JpcnRoZGF0ZT4KCQkJCQkJCQk8R2VuZGVyPk1hbGU8L0dlbmRlcj4KCQkJCQkJCQk8TmFtZVRpdGxlPk1SPC9OYW1lVGl0bGU+CgkJCQkJCQkJPEdpdmVuTmFtZT5zaXg8L0dpdmVuTmFtZT4KCQkJCQkJCQk8U3VybmFtZT5URVNUPC9TdXJuYW1lPgoJCQkJCQkJPC9JbmRpdmlkdWFsPgoJCQkJCQk8L1Bhc3Nlbmdlcj4KCQkJCQkJPFBhc3NlbmdlciBQYXNzZW5nZXJJRD0iU0g3Ij4KCQkJCQkJCTxQVEM+Q0hEPC9QVEM+CgkJCQkJCQk8SW5kaXZpZHVhbD4KCQkJCQkJCQk8QmlydGhkYXRlPjIwMTItMTItMTU8L0JpcnRoZGF0ZT4KCQkJCQkJCQk8R2VuZGVyPk1hbGU8L0dlbmRlcj4KCQkJCQkJCQk8TmFtZVRpdGxlPk1SPC9OYW1lVGl0bGU+CgkJCQkJCQkJPEdpdmVuTmFtZT5zZXZlbjwvR2l2ZW5OYW1lPgoJCQkJCQkJCTxTdXJuYW1lPlRFU1Q8L1N1cm5hbWU+CgkJCQkJCQk8L0luZGl2aWR1YWw+CgkJCQkJCTwvUGFzc2VuZ2VyPgoJCQkJCQk8UGFzc2VuZ2VyIFBhc3NlbmdlcklEPSJTSDgiPgoJCQkJCQkJPFBUQz5JTkY8L1BUQz4KCQkJCQkJCTxJbmRpdmlkdWFsPgoJCQkJCQkJCTxCaXJ0aGRhdGU+MjAxNy0xMi0xNTwvQmlydGhkYXRlPgoJCQkJCQkJCTxHZW5kZXI+TWFsZTwvR2VuZGVyPgoJCQkJCQkJCTxOYW1lVGl0bGU+TVI8L05hbWVUaXRsZT4KCQkJCQkJCQk8R2l2ZW5OYW1lPmVpZ2h0PC9HaXZlbk5hbWU+CgkJCQkJCQkJPFN1cm5hbWU+VEVTVDwvU3VybmFtZT4KCQkJCQkJCTwvSW5kaXZpZHVhbD4KCQkJCQkJPC9QYXNzZW5nZXI+CgkJCQkJCTxQYXNzZW5nZXIgUGFzc2VuZ2VySUQ9IlNIOSI+CgkJCQkJCQk8UFRDPklORjwvUFRDPgoJCQkJCQkJPEluZGl2aWR1YWw+CgkJCQkJCQkJPEJpcnRoZGF0ZT4yMDE3LTEwLTE1PC9CaXJ0aGRhdGU+CgkJCQkJCQkJPEdlbmRlcj5NYWxlPC9HZW5kZXI+CgkJCQkJCQkJPE5hbWVUaXRsZT5NUjwvTmFtZVRpdGxlPgoJCQkJCQkJCTxHaXZlbk5hbWU+bmluZTwvR2l2ZW5OYW1lPgoJCQkJCQkJCTxTdXJuYW1lPlRFU1Q8L1N1cm5hbWU+CgkJCQkJCQk8L0luZGl2aWR1YWw+CgkJCQkJCTwvUGFzc2VuZ2VyPgoJCQkJCTwvUGFzc2VuZ2VyTGlzdD4KCQkJCQk8Q29udGFjdExpc3Q+CgkJCQkJCTxDb250YWN0SW5mb3JtYXRpb24gQ29udGFjdElEPSJDb250YWN0SW5mby1TSDEiPgoJCQkJCQkJPCEtLUNvbnRhY3RUeXBlPlBheW1lbnQ8L0NvbnRhY3RUeXBlLS0+CgkJCQkJCQk8Q29udGFjdFByb3ZpZGVkPgoJCQkJCQkJCTxFbWFpbEFkZHJlc3M+CgkJCQkJCQkJCTxFbWFpbEFkZHJlc3NWYWx1ZT5DQkQuREJBQEJBLkNPTTwvRW1haWxBZGRyZXNzVmFsdWU+CgkJCQkJCQkJPC9FbWFpbEFkZHJlc3M+CgkJCQkJCQk8L0NvbnRhY3RQcm92aWRlZD4KCQkJCQkJCTxDb250YWN0UHJvdmlkZWQ+CgkJCQkJCQkJPFBob25lPgoJCQkJCQkJCQk8TGFiZWw+bW9iaWxlPC9MYWJlbD4KCQkJCQkJCQkJPENvdW50cnlEaWFsaW5nQ29kZT4xMTwvQ291bnRyeURpYWxpbmdDb2RlPgoJCQkJCQkJCQk8QXJlYUNvZGU+NDQ8L0FyZWFDb2RlPgoJCQkJCQkJCQk8UGhvbmVOdW1iZXI+MTExMjIyMTE8L1Bob25lTnVtYmVyPgoJCQkJCQkJCTwvUGhvbmU+CgkJCQkJCQk8L0NvbnRhY3RQcm92aWRlZD4KCQkJCQkJPC9Db250YWN0SW5mb3JtYXRpb24+CgkJCQkJCTxDb250YWN0SW5mb3JtYXRpb24gQ29udGFjdElEPSJQYXllciI+CgkJCQkJCQk8Q29udGFjdFR5cGU+UGF5bWVudDwvQ29udGFjdFR5cGU+CgkJCQkJCQk8Q29udGFjdFByb3ZpZGVkPgoJCQkJCQkJCTxFbWFpbEFkZHJlc3M+CgkJCQkJCQkJCTxFbWFpbEFkZHJlc3NWYWx1ZT50aGlyZC5wYXJ0eUB4eXouY29tPC9FbWFpbEFkZHJlc3NWYWx1ZT4KCQkJCQkJCQk8L0VtYWlsQWRkcmVzcz4KCQkJCQkJCTwvQ29udGFjdFByb3ZpZGVkPgoJCQkJCQkJPENvbnRhY3RQcm92aWRlZD4KCQkJCQkJCQk8UGhvbmU+CgkJCQkJCQkJCTxMYWJlbD5tb2JpbGU8L0xhYmVsPgoJCQkJCQkJCQk8Q291bnRyeURpYWxpbmdDb2RlPjExPC9Db3VudHJ5RGlhbGluZ0NvZGU+CgkJCQkJCQkJCTxBcmVhQ29kZT40NDwvQXJlYUNvZGU+CgkJCQkJCQkJCTxQaG9uZU51bWJlcj44ODg0NDQ0NDQ8L1Bob25lTnVtYmVyPgoJCQkJCQkJCTwvUGhvbmU+CgkJCQkJCQk8L0NvbnRhY3RQcm92aWRlZD4KCQkJCQkJCTxJbmRpdmlkdWFsPgoJCQkJCQkJCTxOYW1lVGl0bGU+TXI8L05hbWVUaXRsZT4KCQkJCQkJCQk8R2l2ZW5OYW1lPk1JS0U8L0dpdmVuTmFtZT4KCQkJCQkJCQk8U3VybmFtZT5URVNUPC9TdXJuYW1lPgoJCQkJCQkJPC9JbmRpdmlkdWFsPgoJCQkJCQk8L0NvbnRhY3RJbmZvcm1hdGlvbj4KCQkJCQk8L0NvbnRhY3RMaXN0PgoJCQkJPC9EYXRhTGlzdHM+CgkJCTwvUXVlcnk+CgkJPC9PcmRlckNyZWF0ZVJRPgoJPC9zb2FwZW52OkJvZHk+Cjwvc29hcGVudjpFbnZlbG9wZT4=`)

func TestCreate(t *testing.T) {

	ref := activity.GetRef(&Activity{})
	act := activity.Get(ref)

	assert.NotNil(t, act)
}

func TestEvalOrdered(t *testing.T) {

	act := &Activity{}
	tc := test.NewActivityContext(act.Metadata())

	tc.SetInput("contentAsJson", inputOrdered)
	tc.SetInput("ordered", true)

	done, err := act.Eval(tc)
	if !done {
		fmt.Println(err)
	}

	var output = fmt.Sprint(tc.GetOutput("contentAsXml"))

	fmt.Println("Input    : ", string(inputOrdered))
	fmt.Println("Expected : ", string(expectedOrdered))
	fmt.Println("Actual   : ", output)

}

func TestEvalUnordered(t *testing.T) {

	act := &Activity{}
	tc := test.NewActivityContext(act.Metadata())

	tc.SetInput("contentAsJson", inputUnordered)
	tc.SetInput("ordered", false)
	done, err := act.Eval(tc)
	if !done {
		fmt.Println(err)
	}

	var output = fmt.Sprint(tc.GetOutput("contentAsXml"))

	fmt.Println("Input    : ", string(inputOrdered))
	fmt.Println("Expected : ", string(expectedOrdered))
	fmt.Println("Actual   : ", output)
}

//func TestAnyXML(t *testing.T) {
//
//	jsonObj, err := xml2json.XmlToJson(xmlData, true)
//	if err != nil {
//		assert.Error(t, err)
//	}
//
//	fmt.Println(string(jsonObj[:len(jsonObj)]))
//
//	xmlObj, err := json2xml.JsonToXml(jsonObj)
//	if err != nil {
//		assert.Error(t, err)
//	}
//
//	fmt.Println(string(xmlObj[:len(xmlObj)]))
//
//}
